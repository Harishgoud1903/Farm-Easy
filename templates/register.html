{% extends "base.html" %}
{% set page = "auth" %}
{% block content %}
<div class="auth-wrap">
  <div class="auth-card">
    <h2>Create account</h2>
    <p class="small-muted">Quickly create an account to save and use predictions</p>

    <form method="POST" action="{{ url_for('register') }}" class="form"
          onsubmit="return validatePassword()">

      <input name="username" id="username" type="text"
             placeholder="Username" required autofocus>

      <input name="password" id="password" type="password"
             placeholder="Password" required>

      <!-- Inline rules (always visible) -->
      <small style="color:#666; display:block; margin-top:-6px; margin-bottom:8px;">
        Password must be at least 8 characters long, include uppercase and lowercase
        letters, a number, a special character, and must not contain the username.
      </small>

      <input id="confirm_password" type="password"
             placeholder="Confirm Password" required>

      <!-- Error message -->
      <small id="error-msg" style="color:red;"></small>

      <button class="btn-primary" type="submit">Register</button>
    </form>

    <div class="auth-footer">
      <small>Already have an account?
        <a href="{{ url_for('login') }}">Login</a>
      </small>
    </div>
  </div>
</div>

<script>
function validatePassword() {
  const usernameRaw = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  const confirmPassword = document.getElementById("confirm_password").value;
  const errorMsg = document.getElementById("error-msg");

  const username = usernameRaw.toLowerCase();
  const passwordLower = password.toLowerCase();

  /* =====================================================
     1Ô∏è‚É£ USERNAME CHECK ‚Äî MUST BE FIRST AND EXCLUSIVE
     ===================================================== */
  if (username && passwordLower.includes(username)) {
    errorMsg.innerText = "Password must not contain the username";
    return false;   // üö´ STOP HERE ‚Äî nothing else runs
  }

  /* =====================================================
     2Ô∏è‚É£ LENGTH
     ===================================================== */
  if (password.length < 8) {
    errorMsg.innerText = "Password must be at least 8 characters long";
    return false;
  }

  /* =====================================================
     3Ô∏è‚É£ UPPERCASE
     ===================================================== */
  if (!/[A-Z]/.test(password)) {
    errorMsg.innerText = "Password must contain at least one uppercase letter";
    return false;
  }

  /* =====================================================
     4Ô∏è‚É£ LOWERCASE
     ===================================================== */
  if (!/[a-z]/.test(password)) {
    errorMsg.innerText = "Password must contain at least one lowercase letter";
    return false;
  }

  /* =====================================================
     5Ô∏è‚É£ NUMBER
     ===================================================== */
  if (!/[0-9]/.test(password)) {
    errorMsg.innerText = "Password must contain at least one number";
    return false;
  }

  /* =====================================================
     6Ô∏è‚É£ SPECIAL CHARACTER
     ===================================================== */
  if (!/[@$!%*?&]/.test(password)) {
    errorMsg.innerText =
      "Password must contain at least one special character (@ $ ! % * ? &)";
    return false;
  }

  /* =====================================================
     7Ô∏è‚É£ CONFIRM PASSWORD
     ===================================================== */
  if (password !== confirmPassword) {
    errorMsg.innerText = "Passwords do not match";
    return false;
  }

  errorMsg.innerText = "";
  return true;
}
</script>
{% endblock %}
